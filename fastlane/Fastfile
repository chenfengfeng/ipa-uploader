# 这一个 Fastfile，使用 Ruby 语法

# 预设平台为 iOS
default_platform(:ios)

platform :ios do
  # 定义一个名为 'upload' 的通道 (lane)
  desc "Upload IPA to App Store Connect"
  lane :upload do
    
    # ⭐️ 关键改动：从环境变量中读取所有认证信息，特别是 .p8 文件的【路径】
    api_key = {
      key_id: ENV["ASC_KEY_ID"],
      issuer_id: ENV["ASC_ISSUER_ID"],
      key_filepath: ENV["ASC_API_KEY_PATH"], # 使用文件路径，而不是文件内容
      is_key_content_base64: false
    }
    
    # 在当前目录中寻找 .ipa 文件的路径
    ipa_path = Dir.glob("*.ipa").first
    
    # 执行上传动作，并明确传入 api_key 参数
    upload_to_app_store(
      api_key: api_key,
      ipa: ipa_path
    )
    
  end
end
